# Aegis (@byted/aegis)

ä¸€ä¸ªä¸“æ³¨äº**å®¹ç¾ (Resilience)**ã€**é«˜æ€§èƒ½**ä¸**ç¦»çº¿ä¼˜å…ˆ (Offline-First)** ä½“éªŒçš„ Service Worker SDKã€‚

> Aegis (ç¥ç›¾) ä¸ºä½ çš„ Web åº”ç”¨æä¾›äº†ä¸€å±‚åšå›ºçš„é˜²æŠ¤ï¼Œç¡®ä¿åº”ç”¨å³ä½¿åœ¨ç½‘ç»œå´©æºƒæˆ–ä»£ç å‡ºç° Bug æ—¶ä¹Ÿèƒ½ä¿æŒç¨³å®šè¿è¡Œã€‚

## æ ¸å¿ƒç‰¹æ€§ (Features)

- ğŸ›¡ï¸ **ç´§æ€¥æ­¢æŸ (Emergency Stop)**: é‡åˆ°ä¸¥é‡æ•…éšœæ—¶ï¼Œå¯ç«‹å³ç»•è¿‡ Service Workerï¼Œå¼ºåˆ¶å›é€€åˆ°ç½‘ç»œï¼Œæ— éœ€é‡æ–°å‘ç‰ˆã€‚
- ğŸ“¡ **API å®¹ç¾ (API Resilience)**: ç½‘ç»œä¼˜å…ˆç­–ç•¥ + è‡ªå®šä¹‰æ ¡éªŒé€»è¾‘ï¼Œé˜²æ­¢é”™è¯¯æ•°æ®æ±¡æŸ“ç¼“å­˜ã€‚
- ğŸŒŠ **SSE ç¦»çº¿å›æ”¾ (SSE Replay)**: ç‹¬æœ‰çš„æµå¼æ•°æ® (Server-Sent Events) ç¦»çº¿æ”¯æŒã€‚
- ğŸš€ **é«˜æ€§èƒ½é™æ€èµ„æº**: é‡‡ç”¨ Stale-while-revalidate ç­–ç•¥ï¼Œç§’å¼€é¡µé¢çš„åŒæ—¶è‡ªåŠ¨æ›´æ–°èµ„æºï¼Œå†…ç½®è‡ªåŠ¨æ¸…ç†æœºåˆ¶ã€‚
- ğŸš **App Shell æ¶æ„**: å†…ç½® SPA å¯¼èˆªå…œåº•ï¼Œç¡®ä¿ç¦»çº¿æ—¶é¡µé¢éª¨æ¶ä¾ç„¶å¯ç”¨ã€‚
- âš¡ **é›¶é˜»å¡ (Zero Blocking)**: é‡‡ç”¨å»¶è¿Ÿæ³¨å†Œç­–ç•¥ï¼Œç¡®ä¿å¯¹é¦–å±æ¸²æŸ“ (First Paint) é›¶å½±å“ã€‚

## å®‰è£… (Installation)

```bash
npm install @byted/aegis
```

## ä½¿ç”¨æŒ‡å— (Usage)

### 1. åˆ›å»º Service Worker (sw.ts)

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `sw.ts` æ–‡ä»¶ï¼š

```typescript
import { createServiceWorker } from '@byted/aegis';

createServiceWorker({
  // API ç¼“å­˜ç­–ç•¥ (ç½‘ç»œä¼˜å…ˆ)
  api: {
    routes: ['/api/v1/'],
    // è‡ªå®šä¹‰æ ¡éªŒï¼šåªæœ‰å½“åç«¯è¿”å›é€»è¾‘æˆåŠŸæ—¶æ‰ç¼“å­˜
    validateResponse: async (data, response) => {
      return data?.code === 0;
    }
  },
  // é™æ€èµ„æºç­–ç•¥ (Stale While Revalidate)
  staticAssets: {
    enabled: true,
    maxAgeSeconds: 30 * 24 * 60 * 60 // 30å¤©
  },
  // SSE æµå¼æ•°æ®ç¼“å­˜
  sse: {
    routes: ['/api/v1/stream']
  },
  // App Shell ç¦»çº¿å…œåº•
  fallback: {
    enabled: true
  }
});
```

### 2. åœ¨å®¢æˆ·ç«¯æ³¨å†Œ (main.ts)

åœ¨ä½ çš„åº”ç”¨å…¥å£æ–‡ä»¶ä¸­ï¼š

```typescript
import { registerServiceWorker } from '@byted/aegis/client';

registerServiceWorker({
  // å‘ç°æ–°ç‰ˆæœ¬æ—¶è‡ªåŠ¨æ›´æ–°
  autoSkipWaiting: true, 
  // æˆ–è€…è‡ªå®šä¹‰ UI æç¤ºï¼š
  // autoSkipWaiting: (update) => showUpdateModal(update)
});
```

---

## æŠ€æœ¯åŸç†ä¸ç”Ÿå‘½å‘¨æœŸ (Technical Architecture)

Aegis çš„è¿è¡Œæµç¨‹ç´§å¯†è´´åˆ Service Worker çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶åœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹æ¤å…¥äº†å®¹ç¾ä¸ä¼˜åŒ–é€»è¾‘ï¼š

1. **å»¶è¿Ÿæ³¨å†Œ (Registration)**:Aegis Client é»˜è®¤ç›‘å¬ `window.onload` äº‹ä»¶ï¼Œç¡®ä¿ä¸»çº¿ç¨‹å…³é”®èµ„æºï¼ˆCSS/JSï¼‰åŠ è½½å®Œæ¯•åï¼Œæ‰å¼€å§‹ä¸‹è½½å’Œæ³¨å†Œ Service Workerã€‚è¿™åˆ©ç”¨äº†æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´ï¼Œé¿å… SW è„šæœ¬æŠ¢å é¦–å±å¸¦å®½ï¼Œç¡®ä¿å¯¹ FCP (First Contentful Paint) é›¶å½±å“ã€‚
2. **å®‰è£…ä¸é¢„ç¼“å­˜ (Install)**:åœ¨ `install` é˜¶æ®µï¼ŒWorkbox è¯»å–æ„å»ºæ—¶ç”Ÿæˆçš„ Manifestï¼Œå°†æ ¸å¿ƒé™æ€èµ„æºï¼ˆApp Shell HTML, Core Assetsï¼‰**åŸå­æ€§**åœ°å†™å…¥ Cache Storageã€‚ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½å¤±è´¥éƒ½ä¼šå¯¼è‡´å®‰è£…ç»ˆæ­¢ï¼Œé˜²æ­¢ä¸å®Œæ•´çš„ç¼“å­˜ç”Ÿæ•ˆã€‚
3. **æ¿€æ´»ä¸æ¥ç®¡ (Activate)**:è§¦å‘ `activate` æ—¶ï¼ŒAegis è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬çš„å“ˆå¸Œèµ„æºï¼Œå¹¶è°ƒç”¨ `clients.claim()` å¼ºåˆ¶æ¥ç®¡å½“å‰æ‰€æœ‰æ‰“å¼€çš„é¡µé¢ï¼Œç¡®ä¿æ–°ç­–ç•¥ç«‹å³ç”Ÿæ•ˆã€‚
4. **è¿è¡Œæ—¶æ‹¦æˆª (Fetch Loop)**:è¿™æ˜¯ Aegis çš„æ ¸å¿ƒè´£ä»»é“¾ï¼Œæ¯ä¸ªç½‘ç»œè¯·æ±‚éƒ½ä¼šä¾æ¬¡ç»è¿‡ä»¥ä¸‹å…³å¡ï¼š

   * **Level 0 - ç†”æ–­ (Kill Switch)**: é¦–å…ˆæ£€æŸ¥å†…å­˜å˜é‡ `swState.enabled`ã€‚è‹¥ä¸º `false`ï¼Œç›´æ¥è¿”å› `NetworkOnly`ï¼ŒçŸ­è·¯åç»­æ‰€æœ‰é€»è¾‘ã€‚è¿™æ˜¯åº”å¯¹çº¿ä¸Šæ•…éšœçš„æ¯«ç§’çº§é€ƒç”Ÿé€šé“ã€‚
   * **Level 1 - æµå¼å¤„ç† (SSE)**: å¯¹äº Server-Sent Eventsï¼ŒAegis ä½¿ç”¨ `tee()` åˆ†æµæŠ€æœ¯ï¼šä¸€è·¯è¿”å›ç»™å‰ç«¯ï¼Œä¸€è·¯é€šè¿‡ `eventsource-parser` åºåˆ—åŒ–ä¸º JSON å­˜å…¥ç¼“å­˜ã€‚ç¦»çº¿æ—¶ï¼Œè¯»å– JSON å¹¶é€šè¿‡ `ReadableStream` é‡æ–°æ¨¡æ‹Ÿåè®®æµï¼Œå®ç°ç‹¬æœ‰çš„â€œç¦»çº¿å›æ”¾â€èƒ½åŠ›ã€‚
   * **Level 2 - API å‡†å…¥ (Smart Cache)**: é‡‡ç”¨æ‰©å±•ç‰ˆ `NetworkFirst` ç­–ç•¥ã€‚åœ¨ç½‘ç»œå“åº”å†™å…¥ç¼“å­˜å‰ï¼Œä¼š**å…‹éš†**å“åº”ä½“å¹¶æ‰§è¡Œç”¨æˆ·é…ç½®çš„ `validateResponse` å‡½æ•°ã€‚åªæœ‰ä¸šåŠ¡é€»è¾‘åˆ¤æ–­æˆåŠŸï¼ˆå¦‚ `code === 0`ï¼‰çš„æ•°æ®æ‰æœ‰èµ„æ ¼è¿›å…¥ç¼“å­˜ï¼Œæœç»â€œå‡æˆåŠŸâ€æ±¡æŸ“ã€‚
   * **Level 3 - é™æ€èµ„æº**: å¯¹äºå›¾ç‰‡/JSï¼Œé‡‡ç”¨ `StaleWhileRevalidate` ç­–ç•¥å®ç°ç§’å¼€ã€‚åŒæ—¶é›†æˆ `ExpirationPlugin`ï¼Œåœ¨è§¦å‘æµè§ˆå™¨å­˜å‚¨é…é¢é™åˆ¶ (`QuotaExceeded`) æ—¶ï¼Œè‡ªåŠ¨æŒ‰ LRU ç®—æ³•æ¸…ç†æ—§ç¼“å­˜ä»¥ä¿å‘½ã€‚
5. **ç¾å¤‡å…œåº• (Fallback)**:
   å½“ä¸Šè¿°æ‰€æœ‰æ‰‹æ®µéƒ½å¤±æ•ˆï¼ˆç½‘ç»œæ–­å¼€ä¸”ç¼“å­˜æœªå‘½ä¸­ï¼‰ï¼Œä¸”è¯·æ±‚ä¸ºé¡µé¢å¯¼èˆª (`navigate`) æ—¶ï¼ŒAegis ä¼šè‡ªåŠ¨ä»é¢„ç¼“å­˜ä¸­æå– `index.html` è¿”å›ã€‚è¿™ç¡®ä¿äº† SPA å³ä½¿åœ¨å®Œå…¨ç¦»çº¿çŠ¶æ€ä¸‹ä¹Ÿèƒ½åŠ è½½å¤–å£³ï¼Œä»è€Œç”±å‰ç«¯è·¯ç”±æ¥ç®¡å¹¶å±•ç¤ºå‹å¥½çš„ç¦»çº¿æç¤ºã€‚

---

## é…ç½®è¯¦æƒ… (Configuration Detail)

ä»¥ä¸‹æ˜¯ `createServiceWorker(config)` çš„å®Œæ•´å‚æ•°è¯´æ˜ã€‚

### 1. API ç­–ç•¥é…ç½® (`api`)

ç”¨äºé…ç½®åç«¯æ¥å£çš„ç¼“å­˜è¡Œä¸ºã€‚ç­–ç•¥é»˜è®¤ä¸º `NetworkFirst`ï¼ˆä¼˜å…ˆå°è¯•ç½‘ç»œï¼Œå¤±è´¥åˆ™è¯»å–ç¼“å­˜ï¼‰ã€‚

| å‚æ•°å                    | ç±»å‹         | å¿…ä¼          | é»˜è®¤å€¼          | è¯´æ˜                                                               |
| :------------------------ | :----------- | :----------- | :-------------- | :----------------------------------------------------------------- |
| `routes`                | `string[]` | **æ˜¯** | -               | éœ€è¦æ‹¦æˆªçš„æ¥å£è·¯å¾„å‰ç¼€åˆ—è¡¨ï¼ˆå¦‚ `['/api/v1']`ï¼‰                   |
| `cacheName`             | `string`   | å¦           | `'api-cache'` | Cache Storage çš„åç§°                                               |
| `validateResponse`      | `Function` | å¦           | `response.ok` | è‡ªå®šä¹‰æ ¡éªŒå‡½æ•° `(data, response) => boolean`ã€‚è¿”å› true æ‰ç¼“å­˜ã€‚ |
| `networkTimeoutSeconds` | `number`   | å¦           | `3`           | ç½‘ç»œè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ã€‚è¶…æ—¶åè‡ªåŠ¨é™çº§åˆ°ç¼“å­˜ã€‚                     |
| `maxEntries`            | `number`   | å¦           | `100`         | æœ€å¤§ç¼“å­˜æ¡ç›®æ•°ï¼ˆLRU ç­–ç•¥ï¼‰                                         |
| `maxAgeSeconds`         | `number`   | å¦           | `86400`       | ç¼“å­˜æœ€å¤§æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶                                 |

#### ç¤ºä¾‹

```typescript
api: {
  routes: ['/api/user'],
  cacheName: 'user-api-cache',
  // ä»…ç¼“å­˜ 10 åˆ†é’Ÿï¼Œæœ€å¤š 50 æ¡
  maxAgeSeconds: 600,
  maxEntries: 50,
  // ä¸šåŠ¡æ ¡éªŒ
  validateResponse: async (data) => data.code === 200
}
```

### 2. é™æ€èµ„æºé…ç½® (`staticAssets`)

ç”¨äºé…ç½® JS/CSS/Image ç­‰èµ„æºçš„ç¼“å­˜ã€‚ç­–ç•¥é»˜è®¤ä¸º `StaleWhileRevalidate`ï¼ˆå³æ—¶è¿”å›ç¼“å­˜ï¼Œåå°æ›´æ–°ï¼‰ã€‚

| å‚æ•°å            | ç±»å‹        | å¿…ä¼  | é»˜è®¤å€¼                 | è¯´æ˜                         |
| :---------------- | :---------- | :--- | :--------------------- | :--------------------------- |
| `enabled`       | `boolean` | å¦   | `true`               | æ˜¯å¦å¼€å¯é™æ€èµ„æºç¼“å­˜         |
| `cacheName`     | `string`  | å¦   | `'static-resources'` | Cache Storage çš„åç§°         |
| `maxEntries`    | `number`  | å¦   | `500`                | æœ€å¤§ç¼“å­˜æ–‡ä»¶æ•°               |
| `maxAgeSeconds` | `number`  | å¦   | `2592000`            | ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 30 å¤© |

#### ç¤ºä¾‹

```typescript
staticAssets: {
  // ç¦ç”¨é™æ€èµ„æºç¼“å­˜
  // enabled: false,
  
  // è‡ªå®šä¹‰è¿‡æœŸç­–ç•¥
  maxEntries: 1000,
  maxAgeSeconds: 7 * 24 * 60 * 60 // 7å¤©
}
```

### 3. SSE æµå¼é…ç½® (`sse`)

ç”¨äºå¤„ç† Server-Sent Events æµå¼æ¥å£ã€‚ç­–ç•¥ä¸ºï¼šæ‹¦æˆªæµ -> è§£æ -> å­˜å‚¨ JSON -> ç¦»çº¿é‡ç»„æµã€‚

| å‚æ•°å            | ç±»å‹         | å¿…ä¼          | é»˜è®¤å€¼          | è¯´æ˜                                                   |
| :---------------- | :----------- | :----------- | :-------------- | :----------------------------------------------------- |
| `routes`        | `string[]` | **æ˜¯** | -               | éœ€è¦æ‹¦æˆªçš„ SSE æ¥å£è·¯å¾„åˆ—è¡¨ï¼ˆå¦‚ `['/chat/stream']`ï¼‰ |
| `cacheName`     | `string`   | å¦           | `'sse-cache'` | Cache Storage çš„åç§°                                   |
| `maxEntries`    | `number`   | å¦           | `50`          | æœ€å¤§ç¼“å­˜æ¡ç›®æ•°                                         |
| `maxAgeSeconds` | `number`   | å¦           | `86400`       | ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶                         |

#### ç¤ºä¾‹

```typescript
sse: {
  routes: ['/api/chat/stream', '/api/stock/feed'],
  // å¢åŠ ç¼“å­˜æ¡æ•°ä»¥æ”¯æŒæ›´é•¿çš„å¯¹è¯å†å²
  maxEntries: 200
}
```

### 4. å¯¼èˆªé…ç½® (`navigation`)

ç”¨äºé…ç½® HTML é¡µé¢çš„ç¼“å­˜ï¼ˆå³ App Shellï¼‰ã€‚ç­–ç•¥é»˜è®¤ä¸º `NetworkFirst`ã€‚

| å‚æ•°å                    | ç±»å‹       | å¿…ä¼  | é»˜è®¤å€¼      | è¯´æ˜                           |
| :------------------------ | :--------- | :--- | :---------- | :----------------------------- |
| `cacheName`             | `string` | å¦   | `'pages'` | Cache Storage çš„åç§°           |
| `networkTimeoutSeconds` | `number` | å¦   | `3`       | ç½‘ç»œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰             |
| `maxEntries`            | `number` | å¦   | `20`      | æœ€å¤§ç¼“å­˜é¡µé¢æ•°                 |
| `maxAgeSeconds`         | `number` | å¦   | `86400`   | ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶ |

#### ç¤ºä¾‹

```typescript
navigation: {
  // è‡ªå®šä¹‰ App Shell ç¼“å­˜å
  cacheName: 'my-app-shell-v2',
  networkTimeoutSeconds: 5 // ç½‘ç»œæ…¢æ—¶ç­‰å¾… 5 ç§’å†å›é€€ç¼“å­˜
}
```

### 5. å…¶ä»–é…ç½®

| é…ç½®é¡¹       | å­å±æ€§       | ç±»å‹         | è¯´æ˜                                                                                                                                    |
| :----------- | :----------- | :----------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
| `ignore`   | `patterns` | `string[]` | **é»‘åå•æ¨¡å¼**ã€‚åŒ…å«è¿™äº›å­—ç¬¦ä¸²çš„ URL å°†ç›´æ¥é€ä¼ ç½‘ç»œï¼Œ**ä¸ç»è¿‡ä»»ä½• SW é€»è¾‘**ã€‚å¸¸ç”¨äºç›‘æ§ä¸ŠæŠ¥ï¼ˆå¦‚ `sentry`, `slardar`ï¼‰ã€‚ |
| `fallback` | `enabled`  | `boolean`  | æ˜¯å¦å¼€å¯ç¦»çº¿å…œåº•ï¼ˆé»˜è®¤ `true`ï¼‰ã€‚å½“å¯¼èˆªè¯·æ±‚å½»åº•å¤±è´¥æ—¶ï¼Œè¿”å›é¢„ç¼“å­˜çš„ `/index.html`ã€‚                                                 |

---

## å®¢æˆ·ç«¯æ³¨å†Œå‚æ•° (RegisterOptions)

`registerServiceWorker(options)` çš„å‚æ•°è¯´æ˜ï¼š

| å‚æ•°å              | ç±»å‹                        | å¿…ä¼  | é»˜è®¤å€¼             | è¯´æ˜                                                                                                                                        |
| :------------------ | :-------------------------- | :--- | :----------------- | :------------------------------------------------------------------------------------------------------------------------------------------ |
| `swUrl`           | `string`                  | å¦   | `'/sw.js'`       | Service Worker æ–‡ä»¶çš„éƒ¨ç½²è·¯å¾„                                                                                                               |
| `autoSkipWaiting` | `boolean` \| `Function` | å¦   | `true`           | æ›´æ–°ç­–ç•¥ã€‚<br>- `true`: è‡ªåŠ¨æ›´æ–°<br>- `false`: æ‰‹åŠ¨æ›´æ–°<br>- `Function`: `(update) => void`ï¼Œè‡ªå®šä¹‰å›è°ƒï¼Œè°ƒç”¨ `update()` è§¦å‘æ›´æ–° |
| `isDev`           | `boolean`                 | å¦   | `process.env...` | å¼ºåˆ¶æŒ‡å®šå¼€å‘æ¨¡å¼ã€‚å¼€å‘æ¨¡å¼ä¸‹ä¸ä¼šè‡ªåŠ¨ `skipWaiting`ï¼Œé˜²æ­¢æ— é™åˆ·æ–°å¾ªç¯ã€‚                                                                    |

#### ç¤ºä¾‹

```typescript
registerServiceWorker({
  swUrl: '/service-worker.js', // è‡ªå®šä¹‰è·¯å¾„ï¼Œå¯ä¸ä¼ 
  // è‡ªå®šä¹‰æ›´æ–° UI
  autoSkipWaiting: (update) => {
    if (confirm('æ–°ç‰ˆæœ¬å·²å°±ç»ªï¼Œæ˜¯å¦åˆ·æ–°ï¼Ÿ')) {
      update();
    }
  }
});
```

## è®¸å¯è¯

ISC
