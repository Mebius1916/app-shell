# Aegis (@byted/aegis)

ä¸€ä¸ªä¸“æ³¨äº**å®¹ç¾ (Resilience)**ã€**é«˜æ€§èƒ½**ä¸**ç¦»çº¿ä¼˜å…ˆ (Offline-First)** ä½“éªŒçš„ Service Worker SDKã€‚

> Aegis (ç¥ç›¾) ä¸ºä½ çš„ Web åº”ç”¨æä¾›äº†ä¸€å±‚åšå›ºçš„é˜²æŠ¤ï¼Œç¡®ä¿åº”ç”¨å³ä½¿åœ¨ç½‘ç»œå´©æºƒæˆ–ä»£ç å‡ºç° Bug æ—¶ä¹Ÿèƒ½ä¿æŒç¨³å®šè¿è¡Œã€‚

## æ ¸å¿ƒç‰¹æ€§ (Features)

- ğŸ›¡ï¸ **ç´§æ€¥æ­¢æŸ (Kill Switch)**: é‡åˆ°çº¿ä¸Šä¸¥é‡æ•…éšœï¼Œç§’çº§å…³é—­ Service Workerï¼Œå¼ºåˆ¶æ‰€æœ‰è¯·æ±‚å›é€€ç½‘ç»œï¼Œæ— éœ€é‡æ–°å‘ç‰ˆã€‚
- ğŸŒŠ **SSE ç¦»çº¿å›æ”¾**: æ”¯æŒ Server-Sent Events æµå¼æ•°æ®çš„ç¦»çº¿å­˜å‚¨ä¸å›æ”¾ï¼Œè®©å®æ—¶åº”ç”¨ï¼ˆå¦‚ AI å¯¹è¯ï¼‰æ–­ç½‘å¯ç”¨ã€‚
- ğŸ§  **æ™ºèƒ½ API å®¹ç¾**: æ·±åº¦å®šåˆ¶çš„ NetworkFirst ç­–ç•¥ï¼Œæ”¯æŒä¸šåŠ¡é€»è¾‘æ ¡éªŒï¼ˆå¦‚ `code === 0`ï¼‰ï¼Œé˜²æ­¢é”™è¯¯æ•°æ®æ±¡æŸ“ç¼“å­˜ã€‚
- âš¡ **é›¶é˜»å¡ (Zero Blocking)**: è‡ªåŠ¨å»¶è¿Ÿæ³¨å†Œï¼Œç¡®ä¿ Service Worker çš„ä¸‹è½½è§£æç»å¯¹ä¸æŠ¢å é¦–å±èµ„æºã€‚

## å®‰è£… (Installation)

```bash
npm install @byted/aegis
```

## ä½¿ç”¨æŒ‡å— (Usage)

### 1. åˆ›å»º Service Worker (sw.ts)

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `sw.ts` æ–‡ä»¶ï¼š

```typescript
import { createServiceWorker } from '@byted/aegis';

createServiceWorker({
  // API ç¼“å­˜ç­–ç•¥ (ç½‘ç»œä¼˜å…ˆ)
  api: {
    routes: ['/api/v1/'],
    // è‡ªå®šä¹‰æ ¡éªŒï¼šåªæœ‰å½“åç«¯è¿”å›é€»è¾‘æˆåŠŸæ—¶æ‰ç¼“å­˜
    validateResponse: async (data, response) => {
      return data?.code === 0;
    }
  },
  // é™æ€èµ„æºç­–ç•¥ (Stale While Revalidate)
  staticAssets: {
    enabled: true,
    maxAgeSeconds: 30 * 24 * 60 * 60 // 30å¤©
  },
  // SSE æµå¼æ•°æ®ç¼“å­˜
  sse: {
    routes: ['/api/v1/stream']
  },
  // App Shell ç¦»çº¿å…œåº•
  fallback: {
    enabled: true
  }
});
```

### 2. åœ¨å®¢æˆ·ç«¯æ³¨å†Œ (main.ts)

åœ¨ä½ çš„åº”ç”¨å…¥å£æ–‡ä»¶ä¸­ï¼š

```typescript
import { registerServiceWorker } from '@byted/aegis/client';

registerServiceWorker({
  // å‘ç°æ–°ç‰ˆæœ¬æ—¶è‡ªåŠ¨æ›´æ–°
  autoSkipWaiting: true, 
  // æˆ–è€…è‡ªå®šä¹‰ UI æç¤ºï¼š
  // autoSkipWaiting: (update) => showUpdateModal(update)
});
```

---

## æŠ€æœ¯åŸç†ä¸ç”Ÿå‘½å‘¨æœŸ (Technical Architecture)

Aegis çš„è¿è¡Œæµç¨‹ç´§å¯†è´´åˆ Service Worker çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶åœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹æ¤å…¥äº†å®¹ç¾ä¸ä¼˜åŒ–é€»è¾‘ï¼š

#### 1. æ³¨å†Œä¸å®‰è£… (Registration & Install)

**ä¸»çº¿ç¨‹**: Aegis Client é»˜è®¤ç›‘å¬ `window.onload` äº‹ä»¶ï¼Œç¡®ä¿ä¸»çº¿ç¨‹å…³é”®èµ„æºï¼ˆCSS/JSï¼‰åŠ è½½å®Œæ¯•åï¼Œæ‰å¼€å§‹ä¸‹è½½å’Œæ³¨å†Œ Service Workerã€‚è¿™åˆ©ç”¨äº†æµè§ˆå™¨çš„ç©ºé—²æ—¶é—´ï¼Œé¿å… SW è„šæœ¬æŠ¢å é¦–å±å¸¦å®½ï¼Œç¡®ä¿å¯¹ FCP (First Contentful Paint) é›¶å½±å“ã€‚

**SW çº¿ç¨‹**: åœ¨ `install` é˜¶æ®µï¼ŒWorkbox è¯»å–æ„å»ºæ—¶ç”Ÿæˆçš„ Manifestï¼Œå°†æ ¸å¿ƒé™æ€èµ„æºï¼ˆApp Shell HTML, Core Assetsï¼‰**åŸå­æ€§**åœ°å†™å…¥ Cache Storageã€‚ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½å¤±è´¥éƒ½ä¼šå¯¼è‡´å®‰è£…ç»ˆæ­¢ï¼Œé˜²æ­¢ä¸å®Œæ•´çš„ç¼“å­˜ç”Ÿæ•ˆã€‚

#### 2. æ¿€æ´»ä¸æ¥ç®¡ (Activate & Claim)

è§¦å‘ `activate` æ—¶ï¼ŒAegis è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬çš„å“ˆå¸Œèµ„æºï¼Œå¹¶è°ƒç”¨ `clients.claim()` å¼ºåˆ¶æ¥ç®¡å½“å‰æ‰€æœ‰æ‰“å¼€çš„é¡µé¢ï¼Œç¡®ä¿æ–°ç­–ç•¥ç«‹å³ç”Ÿæ•ˆã€‚

#### 3. è¿è¡Œæ—¶æ‹¦æˆª (Fetch Loop)

è¿™æ˜¯ Aegis çš„æ ¸å¿ƒè´£ä»»é“¾ï¼Œæ¯ä¸ªç½‘ç»œè¯·æ±‚éƒ½ä¼šä¾æ¬¡ç»è¿‡ä»¥ä¸‹å…³å¡ï¼š

- **Level 0 - ç†”æ–­ (Kill Switch)**é¦–å…ˆæ£€æŸ¥å†…å­˜å˜é‡ `swState.enabled`ã€‚è‹¥ä¸º `false`ï¼Œç›´æ¥è¿”å› `NetworkOnly`ï¼ŒçŸ­è·¯åç»­æ‰€æœ‰é€»è¾‘ã€‚è¿™æ˜¯åº”å¯¹çº¿ä¸Šæ•…éšœçš„æ¯«ç§’çº§é€ƒç”Ÿé€šé“ã€‚
- **Level 1 - æµå¼å¤„ç† (SSE)**å¯¹äº Server-Sent Eventsï¼ŒAegis ä½¿ç”¨ `tee()` åˆ†æµæŠ€æœ¯ï¼šä¸€è·¯è¿”å›ç»™å‰ç«¯ï¼Œä¸€è·¯é€šè¿‡ `eventsource-parser` åºåˆ—åŒ–ä¸º JSON å­˜å…¥ç¼“å­˜ã€‚ç¦»çº¿æ—¶ï¼Œè¯»å– JSON å¹¶é€šè¿‡ `ReadableStream` é‡æ–°æ¨¡æ‹Ÿåè®®æµï¼Œå®ç°ç‹¬æœ‰çš„â€œç¦»çº¿å›æ”¾â€èƒ½åŠ›ã€‚
- **Level 2 - API å‡†å…¥ (Smart Cache)**é‡‡ç”¨æ‰©å±•ç‰ˆ `NetworkFirst` ç­–ç•¥ã€‚åœ¨ç½‘ç»œå“åº”å†™å…¥ç¼“å­˜å‰ï¼Œä¼š**å…‹éš†**å“åº”ä½“å¹¶æ‰§è¡Œç”¨æˆ·é…ç½®çš„ `validateResponse` å‡½æ•°ã€‚åªæœ‰ä¸šåŠ¡é€»è¾‘åˆ¤æ–­æˆåŠŸï¼ˆå¦‚ `code === 0`ï¼‰çš„æ•°æ®æ‰æœ‰èµ„æ ¼è¿›å…¥ç¼“å­˜ï¼Œæœç»â€œå‡æˆåŠŸâ€æ±¡æŸ“ã€‚
- **Level 3 - é™æ€èµ„æº**
  å¯¹äºå›¾ç‰‡/JSï¼Œé‡‡ç”¨ `StaleWhileRevalidate` ç­–ç•¥å®ç°ç§’å¼€ã€‚åŒæ—¶é›†æˆ `ExpirationPlugin`ï¼Œåœ¨è§¦å‘æµè§ˆå™¨å­˜å‚¨é…é¢é™åˆ¶ (`QuotaExceeded`) æ—¶ï¼Œè‡ªåŠ¨æŒ‰ LRU ç®—æ³•æ¸…ç†æ—§ç¼“å­˜ä»¥ä¿å‘½ã€‚

#### 4. ç¾å¤‡å…œåº• (Fallback)

å½“ä¸Šè¿°æ‰€æœ‰æ‰‹æ®µéƒ½å¤±æ•ˆï¼ˆç½‘ç»œæ–­å¼€ä¸”ç¼“å­˜æœªå‘½ä¸­ï¼‰ï¼Œä¸”è¯·æ±‚ä¸ºé¡µé¢å¯¼èˆª (`navigate`) æ—¶ï¼ŒAegis ä¼šè‡ªåŠ¨ä»é¢„ç¼“å­˜ä¸­æå– `index.html` è¿”å›ã€‚è¿™ç¡®ä¿äº† SPA å³ä½¿åœ¨å®Œå…¨ç¦»çº¿çŠ¶æ€ä¸‹ä¹Ÿèƒ½åŠ è½½å¤–å£³ï¼Œä»è€Œç”±å‰ç«¯è·¯ç”±æ¥ç®¡å¹¶å±•ç¤ºå‹å¥½çš„ç¦»çº¿æç¤ºã€‚

---

## é…ç½®è¯¦æƒ… (Configuration Detail)

ä»¥ä¸‹æ˜¯ `createServiceWorker` çš„å®Œæ•´å‚æ•°è¯´æ˜ã€‚

### 1. å¿½ç•¥åå•é…ç½® (`ignore`)

ä½äºç”Ÿå‘½å‘¨æœŸçš„ **Level 0** ä¹‹åã€‚ç”¨äºæŒ‡å®šæŸäº› URL å®Œå…¨ç»•è¿‡ Service Workerï¼Œç›´æ¥é€ä¼ ç½‘ç»œã€‚

| å‚æ•°å       | ç±»å‹         | å¿…ä¼          | è¯´æ˜                                                          |
| :----------- | :----------- | :----------- | :------------------------------------------------------------ |
| `patterns` | `string[]` | **æ˜¯** | éœ€è¦å¿½ç•¥çš„ URL ç‰‡æ®µæˆ–åŸŸåï¼ˆå¦‚ `['/slardar', 'sentry.io']`ï¼‰ |

#### ç¤ºä¾‹

```typescript
createServiceWorker({
  // ...å…¶ä»–é…ç½®
  ignore: {
    // ç›‘æ§ä¸ŠæŠ¥è¯·æ±‚ä¸èµ° SW
    patterns: ['mon.byte.com', '/report/error']
  }
});
```

### 2. API ç­–ç•¥é…ç½® (`api`)

ä½äºç”Ÿå‘½å‘¨æœŸçš„ **Level 2**ã€‚ç”¨äºé…ç½®åç«¯æ¥å£çš„ç¼“å­˜è¡Œä¸ºã€‚

| å‚æ•°å                    | ç±»å‹         | å¿…ä¼          | é»˜è®¤å€¼          | è¯´æ˜                                                               |
| :------------------------ | :----------- | :----------- | :-------------- | :----------------------------------------------------------------- |
| `routes`                | `string[]` | **æ˜¯** | -               | éœ€è¦æ‹¦æˆªçš„æ¥å£è·¯å¾„å‰ç¼€åˆ—è¡¨ï¼ˆå¦‚ `['/api/v1']`ï¼‰                   |
| `cacheName`             | `string`   | å¦           | `'api-cache'` | Cache Storage çš„åç§°                                               |
| `validateResponse`      | `Function` | å¦           | `response.ok` | è‡ªå®šä¹‰æ ¡éªŒå‡½æ•° `(data, response) => boolean`ã€‚è¿”å› true æ‰ç¼“å­˜ã€‚ |
| `networkTimeoutSeconds` | `number`   | å¦           | `3`           | ç½‘ç»œè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ã€‚è¶…æ—¶åè‡ªåŠ¨é™çº§åˆ°ç¼“å­˜ã€‚                     |
| `maxEntries`            | `number`   | å¦           | `100`         | æœ€å¤§ç¼“å­˜æ¡ç›®æ•°ï¼ˆLRU ç­–ç•¥ï¼‰                                         |
| `maxAgeSeconds`         | `number`   | å¦           | `86400`       | ç¼“å­˜æœ€å¤§æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶                                 |

#### ç¤ºä¾‹

```typescript
createServiceWorker({
  // ...å…¶ä»–é…ç½®
  api: {
    routes: ['/api/user'],
    cacheName: 'user-api-cache',
    // ä»…ç¼“å­˜ 10 åˆ†é’Ÿï¼Œæœ€å¤š 50 æ¡
    maxAgeSeconds: 600,
    maxEntries: 50,
    // ä¸šåŠ¡æ ¡éªŒ
    validateResponse: async (data) => data.code === 200
  }
});
```

### 3. SSE æµå¼é…ç½® (`sse`)

ä½äºç”Ÿå‘½å‘¨æœŸçš„ **Level 1**ã€‚ç”¨äºå¤„ç† Server-Sent Events æµå¼æ¥å£ã€‚

| å‚æ•°å            | ç±»å‹         | å¿…ä¼          | é»˜è®¤å€¼          | è¯´æ˜                                                   |
| :---------------- | :----------- | :----------- | :-------------- | :----------------------------------------------------- |
| `routes`        | `string[]` | **æ˜¯** | -               | éœ€è¦æ‹¦æˆªçš„ SSE æ¥å£è·¯å¾„åˆ—è¡¨ï¼ˆå¦‚ `['/chat/stream']`ï¼‰ |
| `cacheName`     | `string`   | å¦           | `'sse-cache'` | Cache Storage çš„åç§°                                   |
| `maxEntries`    | `number`   | å¦           | `50`          | æœ€å¤§ç¼“å­˜æ¡ç›®æ•°                                         |
| `maxAgeSeconds` | `number`   | å¦           | `86400`       | ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶                         |

#### ç¤ºä¾‹

```typescript
createServiceWorker({
  // ...å…¶ä»–é…ç½®
  sse: {
    routes: ['/api/chat/stream', '/api/stock/feed'],
    // å¢åŠ ç¼“å­˜æ¡æ•°ä»¥æ”¯æŒæ›´é•¿çš„å¯¹è¯å†å²
    maxEntries: 200
  }
});
```

### 4. é™æ€èµ„æºé…ç½® (`staticAssets`)

ä½äºç”Ÿå‘½å‘¨æœŸçš„ **Level 3**ã€‚ç”¨äºé…ç½® JS/CSS/Image ç­‰èµ„æºçš„ç¼“å­˜ã€‚

| å‚æ•°å            | ç±»å‹        | å¿…ä¼  | é»˜è®¤å€¼                 | è¯´æ˜                         |
| :---------------- | :---------- | :--- | :--------------------- | :--------------------------- |
| `enabled`       | `boolean` | å¦   | `true`               | æ˜¯å¦å¼€å¯é™æ€èµ„æºç¼“å­˜         |
| `cacheName`     | `string`  | å¦   | `'static-resources'` | Cache Storage çš„åç§°         |
| `maxEntries`    | `number`  | å¦   | `500`                | æœ€å¤§ç¼“å­˜æ–‡ä»¶æ•°               |
| `maxAgeSeconds` | `number`  | å¦   | `2592000`            | ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 30 å¤© |

#### ç¤ºä¾‹

```typescript
createServiceWorker({
  // ...å…¶ä»–é…ç½®
  staticAssets: {
    // ç¦ç”¨é™æ€èµ„æºç¼“å­˜
    // enabled: false,
  
    // è‡ªå®šä¹‰è¿‡æœŸç­–ç•¥
    maxEntries: 1000,
    maxAgeSeconds: 7 * 24 * 60 * 60 // 7å¤©
  }
});
```

### 5. å¯¼èˆªä¸å…œåº•é…ç½® (`navigation` & `fallback`)

ä½äºç”Ÿå‘½å‘¨æœŸçš„ **Fallback** é˜¶æ®µã€‚

#### å¯¼èˆªé…ç½® (`navigation`)

| å‚æ•°å                    | ç±»å‹       | å¿…ä¼  | é»˜è®¤å€¼      | è¯´æ˜                           |
| :------------------------ | :--------- | :--- | :---------- | :----------------------------- |
| `cacheName`             | `string` | å¦   | `'pages'` | Cache Storage çš„åç§°           |
| `networkTimeoutSeconds` | `number` | å¦   | `3`       | ç½‘ç»œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰             |
| `maxEntries`            | `number` | å¦   | `20`      | æœ€å¤§ç¼“å­˜é¡µé¢æ•°                 |
| `maxAgeSeconds`         | `number` | å¦   | `86400`   | ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 24 å°æ—¶ |

#### å…œåº•é…ç½® (`fallback`)

| å‚æ•°å      | ç±»å‹        | å¿…ä¼  | é»˜è®¤å€¼   | è¯´æ˜                                                                   |
| :---------- | :---------- | :--- | :------- | :--------------------------------------------------------------------- |
| `enabled` | `boolean` | å¦   | `true` | æ˜¯å¦å¼€å¯ç¦»çº¿å…œåº•ã€‚å½“å¯¼èˆªè¯·æ±‚å½»åº•å¤±è´¥æ—¶ï¼Œè¿”å›é¢„ç¼“å­˜çš„ `/index.html`ã€‚ |

#### ç¤ºä¾‹

```typescript
createServiceWorker({
  // ...å…¶ä»–é…ç½®
  // å¯¼èˆªç­–ç•¥
  navigation: {
    cacheName: 'my-app-shell-v2',
    networkTimeoutSeconds: 5
  },
  // å¼€å¯ç¦»çº¿å…œåº•
  fallback: {
    enabled: true
  }
});
```

### 6. é”™è¯¯ä¸ŠæŠ¥ (`onError`)

å…¨å±€é”™è¯¯æ•è·ï¼Œè´¯ç©¿æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚

| å‚æ•°å      | ç±»å‹         | è¯´æ˜                                                                                |
| :---------- | :----------- | :---------------------------------------------------------------------------------- |
| `onError` | `Function` | å…¨å±€é”™è¯¯æ•è·å›è°ƒ `(error, event) => void`ã€‚å¯ç”¨äºå¯¹æ¥ Sentry/Slardar ç­‰ç›‘æ§å¹³å°ã€‚ |

#### ç¤ºä¾‹

```typescript
createServiceWorker({
  // ...å…¶ä»–é…ç½®
  onError: (error, event) => {
    console.error('[Aegis Error]', error);
  // Sentry.captureException(error);
  }
});
```

---

## å®¢æˆ·ç«¯æ³¨å†Œå‚æ•° (RegisterOptions)

`registerServiceWorker` çš„å‚æ•°è¯´æ˜ï¼š

| å‚æ•°å              | ç±»å‹                        | å¿…ä¼  | é»˜è®¤å€¼             | è¯´æ˜                                                                                                                                        |
| :------------------ | :-------------------------- | :--- | :----------------- | :------------------------------------------------------------------------------------------------------------------------------------------ |
| `swUrl`           | `string`                  | å¦   | `'/sw.js'`       | Service Worker æ–‡ä»¶çš„éƒ¨ç½²è·¯å¾„                                                                                                               |
| `autoSkipWaiting` | `boolean` \| `Function` | å¦   | `true`           | æ›´æ–°ç­–ç•¥ã€‚<br>- `true`: è‡ªåŠ¨æ›´æ–°<br>- `false`: æ‰‹åŠ¨æ›´æ–°<br>- `Function`: `(update) => void`ï¼Œè‡ªå®šä¹‰å›è°ƒï¼Œè°ƒç”¨ `update()` è§¦å‘æ›´æ–° |
| `isDev`           | `boolean`                 | å¦   | `process.env...` | å¼ºåˆ¶æŒ‡å®šå¼€å‘æ¨¡å¼ã€‚å¼€å‘æ¨¡å¼ä¸‹ä¸ä¼šè‡ªåŠ¨ `skipWaiting`ï¼Œé˜²æ­¢æ— é™åˆ·æ–°å¾ªç¯ã€‚                                                                    |

#### ç¤ºä¾‹

```typescript
registerServiceWorker({
  swUrl: '/service-worker.js', // è‡ªå®šä¹‰è·¯å¾„ï¼Œå¯ä¸ä¼ 
  // è‡ªå®šä¹‰æ›´æ–° UI
  autoSkipWaiting: (update) => {
    if (confirm('æ–°ç‰ˆæœ¬å·²å°±ç»ªï¼Œæ˜¯å¦åˆ·æ–°ï¼Ÿ')) {
      update();
    }
  }
});
```

## è®¸å¯è¯

ISC
